<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@40,400,0,0" />
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.0.0/jsencrypt.min.js"></script>
    <title>Encrypted P2P Chat</title>
</head>
<body>
  <button type="button" class="collapsible">Toggle logs</button>

  <div class="content" id="content">
  </div>

  <div id="chat">
  </div>
  <div id="message"> 
      <input type="text" class="textbox" autocomplete="off" placeholder="Type something..." id="textbox">
      <button id="send" onclick="pushh()"><span class="material-symbols-outlined">send</span></button>
  </div>
  <div id="overlay"> 
      <div id="user">
          <h1>Encrypted Peer-to-peer Messaging</h1>
          <input id="username" type="text" class="textbox" placeholder="Username" value="">
          <button class="done" onclick="initializePeer();">Start Chatting</button>
      </div>
  </div>

  <script>
    var otheruserpack;
    let conn = null;
    var skib = false;
    var userpacket = {
        "username": "",
        "publicKey": ""
    }

    var crypt;
    var privateKey;
    var publicKey;

    function generateKeypair() {
        try {
            crypt = new JSEncrypt({ default_key_size: 2048 });
            privateKey = crypt.getPrivateKey();
            publicKey = crypt.getPublicKey();
            return publicKey;
        } catch (error) {
            logg('Error generating keypair: ' + error.message);
            displayMessage('Error generating encryption keys. Please refresh and try again.', 'sys');
            return null;
        }
    }

    function encrypt(content, recipientPublicKey) {
        try {
            var encryptor = new JSEncrypt();
            encryptor.setPublicKey(recipientPublicKey);
            return encryptor.encrypt(content);
        } catch (error) {
            logg('Error encrypting message: ' + error.message);
            displayMessage('Error encrypting message. It was not sent.', 'sys');
            return null;
        }
    }

    function decrypt(content) {
        try {
            crypt.setPrivateKey(privateKey);
            return crypt.decrypt(content);
        } catch (error) {
            logg('Error decrypting message: ' + error.message);
            displayMessage('Error decrypting message. It could not be displayed.', 'sys');
            return null;
        }
    }

    document.querySelector('#textbox').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            pushh();
        }
    });

    $(".collapsible").click(function () {
        const isTransformed = $(this).css("transform") !== 'none';
        $(this).css("transform", isTransformed ? "" : "translate(0px, 200px)");
        $(".content").css("transform", isTransformed ? "" : "translate(0px, 200px)");
    });

    function logg(message) {
        const date = new Date();
        const timeString = `<span class="log-time">(${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')})</span> ${message}`;
        const log = document.createElement("p");
        log.innerHTML = timeString;
        document.getElementById("content").prepend(log);
    }

    function initializePeer() {
        const username = document.getElementById("username").value.trim();
        if (!username) {
            alert("Please enter a username.");
            return;
        }
        userpacket.username = username;
        document.getElementById("overlay").innerHTML = "<h1>Connecting...</h1>";
        peer = new Peer(null, { debug: 2 });

        peer.on('open', function (id) {
            logg('Peer ID: ' + (peer.id || lastPeerId));
            displayMessage('Your peer ID: ' + (peer.id || lastPeerId), 'sys');
            displayMessage('To connect to a peer, type their peer ID into the message box and press send or Return', 'sys');
            if (peer.id === null) peer.id = lastPeerId;
            $("#overlay").hide();
        });

        peer.on('connection', function (incomingConn) {
            logg('Incoming connection from peer: ' + incomingConn.peer);
            conn = incomingConn;
            setupConnectionHandlers(conn);
        });

        peer.on('disconnected', function () {
            displayMessage("Connection lost. Attempting to reconnect...", 'sys');
            logg('Connection lost. Attempting to reconnect...');
            peer.id = lastPeerId;
            peer.reconnect();
        });

        peer.on('close', function () {
            displayMessage('Connection destroyed. Please refresh the page.', 'sys');
            logg("Connection destroyed. Please refresh the page.");
        });

        peer.on('error', function (err) {
            displayMessage('Error occurred: ' + err.type, 'sys');
            logg('Error: ' + err.type);
        });
    }

    function setupConnectionHandlers(connection) {
        connection.on('open', function () {
            userpacket.publicKey = generateKeypair();
            if (userpacket.publicKey) {
                conn.send(userpacket);
            } else {
                displayMessage('Failed to generate encryption keys. Connection aborted.', 'sys');
                connection.close();
            }
        });

        connection.on('data', function (data) {
            if (!skib) {
                skib = true;
                otheruserpack = data;
                logg('Connection established with peer: ' + otheruserpack.username + ' (' + connection.peer + ')');
                displayMessage('Connected to peer: ' + otheruserpack.username + ' (' + connection.peer + ')', 'sys');
            } else {
                const decryptedMessage = decrypt(data);
                if (decryptedMessage) {
                    logg('Received message: ' + decryptedMessage);
                    displayMessage(decryptedMessage, 'other');
                }
            }
        });

        connection.on('error', function (err) {
            logg('Connection error: ' + err);
            displayMessage('Connection error: ' + err, 'sys');
        });

        connection.on('close', function () {
            logg('Connection closed with peer: ' + connection.peer);
            displayMessage('Connection closed with peer: ' + connection.peer, 'sys');
            skib = false;
            conn = null;
        });
    }

    function connectToPeer(remotePeerId) {
        if (conn) {
            displayMessage('You are already connected to a peer. Please disconnect first.', 'sys');
            return;
        }
        conn = peer.connect(remotePeerId);
        setupConnectionHandlers(conn);
    }

    function pushh() {
        const message = document.getElementById("textbox").value.trim();
        if (message === "") return;

        if (conn && conn.open) {
            const encryptedMessage = encrypt(message, otheruserpack.publicKey);
            if (encryptedMessage) {
                conn.send(encryptedMessage);
                displayMessage(message, 'self');
            }
        } else if (!conn) {
            connectToPeer(message);
        } else {
            displayMessage('Connection not open. Message not sent.', 'sys');
        }
        document.getElementById("textbox").value = "";
    }

    function displayMessage(message, type) {
        const newMsgCont = document.createElement("div");
        const newMsg = document.createElement("div");

        newMsgCont.classList.add("chat-" + type);
        newMsg.classList.add("chat-" + type + "-bubble");

        newMsg.innerHTML = DOMPurify.sanitize(message);
        newMsgCont.appendChild(newMsg);
        document.getElementById("chat").prepend(newMsgCont);
    }
  </script>

  <style>
    :root {
      --bg-color: #1e1e1e;
      --text-color: #e0e0e0;
      --primary-color: #4a4aff;
      --secondary-color: #2c2c2c;
      --tertiary-color: #3a3a3a;
      --system-message-color: #a0a0a0;
      --scrollbar-thumb-color: #555555;
      --scrollbar-thumb-hover-color: #777777;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: Arial, sans-serif;

        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    h1 {
        font-size: 24px;
        text-align: center;
        margin-bottom: 20px;
    }

    #chat {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column-reverse;
    }

    .chat-self, .chat-other, .chat-sys {
        margin-bottom: 10px;
        max-width: 70%;
    }

    .chat-self {
        align-self: flex-end;
    }

    .chat-other {
        align-self: flex-start;
    }

    .chat-sys {
        align-self: center;
    }

    .chat-self-bubble {
        background-color: var(--primary-color);
        color: var(--bg-color);
        padding: 10px;
        border-radius: 20px;
        border-bottom-right-radius: 5px;
    }

    .chat-other-bubble {
        background-color: var(--secondary-color);
        color: var(--text-color);
        padding: 10px;
        border-radius: 20px;
        border-bottom-left-radius: 5px;
    }

    .chat-sys-bubble {
        background-color: var(--tertiary-color);
        color: var(--system-message-color);
        padding: 5px 10px;
        border-radius: 10px;
        font-size: 0.9em;
    }

    #message {
        display: flex;
        padding: 20px;
        background-color: var(--tertiary-color);
    }

    .textbox {
        flex: 1;
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: none;
        padding: 10px;
        border-radius: 20px;
        margin-right: 10px;
        font-size: 16px;
    }

    #send {
        background-color: var(--primary-color);
        color: var(--text-color);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .collapsible {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: none;
        padding: 10px;
        width: 200px;
        text-align: center;
        cursor: pointer;
        position: fixed;
        top: 0;
        left: 20px;
        z-index: 10;
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
        transition: 0.5s ease-in-out;
    }

    .content {
        background-color: var(--tertiary-color);
        padding: 10px;
        width: 180px;
        height: 200px;
        position: fixed;
        top: -220px;
        left: 20px;
        transition: 0.3s;
        overflow-y: auto;
        z-index: 9;
        transition: 0.5s ease-in-out;
    }

    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }

    #user {
        background-color: var(--tertiary-color);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
    }

    .done {
        background-color: var(--primary-color);
        color: var(--text-color);
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
    }

    .log-time {
        color: var(--system-message-color);
        font-size: 0.8em;
    }

    /* Scrollbar Styles */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--scrollbar-thumb-color);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--scrollbar-thumb-hover-color);
    }
  </style>
</body>
</html>
